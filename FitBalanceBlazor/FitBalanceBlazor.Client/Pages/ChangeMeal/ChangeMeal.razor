@page "/changeMeal"
@using System.IdentityModel.Tokens.Jwt
@using Blazored.LocalStorage
@using ClassLibrary1
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage

<PageTitle>Change diet</PageTitle>
<MudText Align="Align.Center" Typo="Typo.h1" Style="text-transform: uppercase;"><strong>zmiana posilku</strong></MudText>

<MudGrid>
    <!-- Lewa strona -->
    <MudItem xs="6">
        <MudStack Spacing="3">
         
            <MudPaper Class="pa-3" Style="width:100%;background:rgb(223,243,156);border-radius: 20px;">
                <MudText Typo="Typo.h6">Twoja przypisana dieta:</MudText>
                <MudText Typo="Typo.body1">@currentDiet?.nazwa</MudText>
            </MudPaper>

            <!-- Sekcja wyboru dania -->
            <MudPaper Class="pa-3" Style="width:100%;background:rgb(223,243,156);border-radius: 20px;">
                <MudText Typo="Typo.h6">Która pozycję chcesz zmienić?</MudText>
                <MudForm>
                    <MudRadioGroup @bind-Value="selectedMeal">
                        <MudStack>
                            @if (currentDiet?.Danie_id_danie != null && currentDiet.Danie_id_danie.Any())
                            {
                                @foreach (var danie in currentDiet.Danie_id_danie)
                                {
                                    <MudRadio Value="@danie.nazwa" Color="Color.Primary">@danie.nazwa</MudRadio>
                                }
                            }
                            else
                            {
                                <MudText Typo="Typo.body2">Brak dostępnych dań w tej diecie.</MudText>
                            }
                        </MudStack>
                    </MudRadioGroup>
                </MudForm>
                <div class="d-flex align-center">
                    <MudText Class="ml-4">Wybrana opcja: @selectedMeal</MudText>
                    <MudButton Variant="Variant.Filled"
                               Style="width: 150px;background:rgb(255,152,107);border-radius: 20px;"
                               Href="/changeCertainMeal">
                        Zatwierdź
                    </MudButton>

                </div>
            </MudPaper>
        </MudStack>
    </MudItem>

    <!-- Obrazek -->
    <MudItem xs="6">
        <MudCard Style="width:100%; position: relative;">
            <MudCardMedia Image="/Images/ChangeMeal/ChangeMeal.png" Height="500" />
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private Dieta currentDiet;
    private Uzytkownik user;
    private JwtSecurityToken jwt { get; set; } 
    private List<Danie> dania=new List<Danie>();
    private Danie selectedMeal;
    public Dieta selectedDiet { get; set; }
    private List<int> Meals = [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var TokenText = await LocalStorage.GetItemAsStringAsync("authToken");
            jwt = new JwtSecurityTokenHandler().ReadJwtToken(TokenText);
            var claim = jwt.Claims.First(c => c.Type.Equals("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"));
            /*var userResponse = await Http.GetFromJsonAsync<ServiceResponse<Uzytkownik>>($"api/user/{claim.Value}");*/
            var userResponse = await Http.GetFromJsonAsync<ServiceResponse<Uzytkownik>>($"api/user/3");
            user = userResponse.Data;
            
            
            var DietResponse = await Http.GetFromJsonAsync<ServiceResponse<Dieta>>($"http://localhost:5131/api/Diet/{user.Przypisana_dieta.ToList()[0].id_dieta}");
            selectedDiet = DietResponse.Data;
            var MealResponse = await Http.GetFromJsonAsync<ServiceResponse<List<Danie>>>("http://localhost:5131/api/Meal");
            dania = MealResponse.Data;
            
            
            // Trzeba zamieniac ID
            var currentDietResponse = await Http.GetFromJsonAsync<ServiceResponse<Dieta>>("api/Diet/3");
            currentDiet = currentDietResponse.Data;
            
            if (currentDiet == null)
            {
                Console.WriteLine("Diet not found.");
            }
            else if (currentDiet.Danie_id_danie == null || !currentDiet.Danie_id_danie.Any())
            {
                Console.WriteLine("No meals found for this diet.");
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
    }

   
}
