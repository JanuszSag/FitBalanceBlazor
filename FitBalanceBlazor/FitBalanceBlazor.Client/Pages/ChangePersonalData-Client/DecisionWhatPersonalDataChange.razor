@page "/informationAboutPersonalData/decisionWhatPersonalDataChange/{UserId:int}"
@inject NavigationManager NavigationManager
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http

<PageTitle>Decision What Personal Data Change</PageTitle>
<MudText Align="Align.Center" Typo="Typo.h1" Style="text-transform: uppercase;">
    <strong>Zmiana danych osobowych</strong>
</MudText>

<MudGrid>
    <MudItem xs="6">
        <MudCard Class="pa-3" Style="width:100%;background:rgb(223,243,156);border-radius: 20px; height: auto;">
            <MudCardContent>
                <MudStack Spacing="5">
                    <MudText Align="Align.Left" Typo="Typo.h4"><strong>Edytuj dane </strong></MudText>

                    <MudForm @ref="form" IsValid="@isValid" OnValidSubmit="Submit">
                        <!-- Login -->
                        <MudTextField Label="Login" @bind-Value="Nickname" Variant="Variant.Outlined" Class="mb-3" FullWidth="true"
                                      For="@(() => Nickname)" />
                        <ValidationMessage For="@(() => Nickname)" />

                        <!-- Email -->
                        <MudTextField Label="E-mail" @bind-Value="Email" Variant="Variant.Outlined" Class="mb-3" FullWidth="true"
                                      For="@(() => Email)" />
                        <ValidationMessage For="@(() => Email)" />

                        <!-- Data urodzenia -->
                        <MudDatePicker Label="Data urodzenia" @bind-Date="BirthDate" Variant="Variant.Outlined" Class="mb-3" />
                        <ValidationMessage For="@(() => BirthDate)" />

                        <!-- Płeć -->
                        <MudSelect Label="Płeć" @bind-Value="Gender" Variant="Variant.Outlined" Class="mb-3">
                            <MudSelectItem Value=@("Mężczyzna")>Mężczyzna</MudSelectItem>
                            <MudSelectItem Value=@("Kobieta")>Kobieta</MudSelectItem>
                            <MudSelectItem Value=@("Inne")>Inne</MudSelectItem>
                        </MudSelect>
                        <ValidationMessage For="@(() => Gender)" />

                        <!-- Wzrost -->
                        <MudTextField Label="Wzrost (cm)" @bind-Value="Height" Variant="Variant.Outlined" Class="mb-3" FullWidth="true"
                                      For="@(() => Height)" />
                        <ValidationMessage For="@(() => Height)" />

                        <!-- Waga -->
                        <MudTextField Label="Waga (kg)" @bind-Value="Weight" Variant="Variant.Outlined" Class="mb-3" FullWidth="true"
                                      For="@(() => Weight)" />
                        <ValidationMessage For="@(() => Weight)" />

                        <!-- Hasło -->
                        <MudTextField Label="Hasło" @bind-Value="Password" InputType="InputType.Password" Variant="Variant.Outlined" Class="mb-3" FullWidth="true"
                                      For="@(() => Password)" />
                        <ValidationMessage For="@(() => Password)" />

                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Style="width: auto;background:rgb(255,152,107);border-radius: 20px;">
                            Zatwierdź
                        </MudButton>
                    </MudForm>
                </MudStack>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6">
        <MudCard Style="width:100%; position: relative;">
            <MudImage Fluid="true" Src="/Images/PersonalData/DataImage.png" Alt="Image" Class="rounded-lg"/>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private MudForm form;
    private bool isValid;
    
    [Parameter] public int UserId { get; set; }
    
    [StringLength(20, ErrorMessage = "Login może mieć maksymalnie 20 znaków.")]
    public string Nickname { get; set; } = string.Empty;

    [EmailAddress(ErrorMessage = "Nieprawidłowy format e-mail.")]
    public string Email { get; set; } = string.Empty;

    [DataType(DataType.Date)]
    public DateTime? BirthDate { get; set; }

    public string Gender { get; set; } = string.Empty;

    [Range(50, 250, ErrorMessage = "Wzrost musi być między 50 a 250 cm.")]
    public int Height { get; set; }

    [Range(10, 300, ErrorMessage = "Waga musi być między 10 a 300 kg.")]
    public int Weight { get; set; }
    
    [StringLength(20, MinimumLength = 5, ErrorMessage = "Hasło musi mieć od 5 do 20 znaków.")]
    public string Password { get; set; } = string.Empty;

  
    // Metoda wywoływana po zatwierdzeniu poprawności formularza, przekazuje parametry do kolejnej strony
    private void OnValidSubmit(EditContext context) // EditContext to klasa w ASP.NET Core Blazor, która jest używana do zarządzania stanem i walidacją formularzy.
    {

// NavigationManager.NavigateTo($"/changeDiet/changeIngredientsInDiet?SelectedOption={Uri.EscapeDataString(modelChangeDiet.SelectedOption)}");

        StateHasChanged();
    }
    //Obsługa endpointów
    private List<Uzytkownik> uzytkownicy=new List<Uzytkownik>();
    
    protected override async Task OnInitializedAsync()
    { 
        try
        { 
            // uzytkownicy = await Http.GetFromJsonAsync<List<Uzytkownik>("api/");//dodac api
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd podczas pobierania danych: {ex.Message}");
        }
    }

    private async void Submit()
    {
        
        var user = new Uzytkownik()
        {
            id_uzytkownik = UserId,
            pseudonim = Nickname,
            email = Email,
            data_urodzenia = DateOnly.FromDateTime((DateTime)BirthDate!),
            plec = Gender,
            wzrost = Height,
            waga = Weight
        };
        await Http.PutAsJsonAsync("Api/user/", user);
        
        NavigationManager.NavigateTo("/informationAboutPersonalData");
    }
}
