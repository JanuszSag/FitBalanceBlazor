@page "/raport"
@using System.Net
@using System.Net.Http.Json
@using MudBlazor
@using System.IdentityModel.Tokens.Jwt
@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage
@inject HttpClient Http


<MudGrid Class="pa-4">
    <!-- Naglowek -->
    <MudItem xs="12" Class="text-center">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mt-4">
            Miesięczny raport zmiany wagi
        </MudText>
    </MudItem>

    <!-- Tabela danych -->
    <MudItem xs="12" Class="mt-4">
        @if (Weights != null)
        {
            <MudTable Items="Weights" Elevation="2">
                <HeaderContent>
                    <MudTh>Data pomiaru</MudTh>
                    <MudTh>Waga</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Date.ToShortDateString()</MudTd>
                    <MudTd>@context.Weight kg</MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudProgressCircular Indeterminate="true" Class="m-auto" />
        }
    </MudItem>
</MudGrid>

@code {
   // [Parameter] public int UserId { get; set; } = 1;

    private List<UserWeight> Weights;
    private JwtSecurityToken jwt { get; set; }
    private string UserIdFromToken { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var TokenText = await LocalStorage.GetItemAsStringAsync("authToken");
            jwt = new JwtSecurityTokenHandler().ReadJwtToken(TokenText);
            var claim = jwt.Claims.FirstOrDefault(c => c.Type.Equals("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"));
            UserIdFromToken = claim?.Value;

            if (!string.IsNullOrEmpty(UserIdFromToken))
            {
                var response = await Http.GetFromJsonAsync<WeightResponse>($"api/Report/Weight/{UserIdFromToken}");

                if (response?.Data != null)
                {
                    Weights = response.Data.Select(w => new UserWeight
                    {
                        Date = DateTime.Parse(w.Data),
                        Weight = w.Waga
                    }).ToList();
                }
            }
            else
            {
                Console.WriteLine("Nie udało się pobrać ID użytkownika z tokena.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd podczas ładowania danych: {ex.Message}");
        }
    }

    private class WeightResponse
    {
        public List<ApiWeight> Data { get; set; }
        public bool Success { get; set; }
        public string Message { get; set; }
    }

    private class ApiWeight
    {
        public string Data { get; set; }
        public double Waga { get; set; }
    }

    private class UserWeight
    {
        public DateTime Date { get; set; }
        public double Weight { get; set; }
    }
}
